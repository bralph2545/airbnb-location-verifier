{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-6 mx-auto">
            <!-- Header -->
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                <h1 class="h3 mt-3 mb-2 fw-semibold">Quick Verification Failed</h1>
                <p class="text-muted">We couldn't extract location data using Quick Verify mode</p>
            </div>
            
            <!-- Options Card -->
            <div class="card location-card">
                <div class="card-header">
                    <h2 class="h5 mb-0">What would you like to do?</h2>
                </div>
                <div class="card-body">
                    
                    <!-- Option 1: Queue for Deep Analysis -->
                    <div class="mb-4">
                        <h3 class="h6 mb-3">
                            <i class="fas fa-microscope me-2 text-primary"></i>
                            Option 1: Queue for Deep Analysis (Recommended)
                        </h3>
                        <p class="small text-muted mb-3">
                            Our deep analysis system will thoroughly process this listing using:
                        </p>
                        <ul class="small text-muted mb-3">
                            <li>Advanced AI vision analysis on all photos</li>
                            <li>Multiple OCR systems for maximum accuracy</li>
                            <li>Street view verification</li>
                            <li>NLP-based location extraction</li>
                        </ul>
                        
                        <form id="queue-form" method="post">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" id="notes" name="notes" rows="2" 
                                    placeholder="Any special instructions or context about this listing..."></textarea>
                            </div>
                            
                            <button type="button" id="queue-btn" class="btn btn-primary w-100">
                                <i class="fas fa-plus-circle me-2"></i>
                                Queue for Deep Analysis
                            </button>
                        </form>
                        
                        <div id="queue-status" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Successfully Queued!</strong>
                                <p class="mb-0 mt-2">
                                    Your job has been added to the queue.<br>
                                    Position: <span id="queue-position">-</span><br>
                                    Job ID: <span id="job-id">-</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Option 2: Try Again -->
                    <div class="mb-3">
                        <h3 class="h6 mb-3">
                            <i class="fas fa-redo me-2 text-info"></i>
                            Option 2: Try Again with Thorough Analysis
                        </h3>
                        <p class="small text-muted mb-3">
                            Run the thorough analysis immediately (takes 30-45 seconds)
                        </p>
                        
                        <form method="post" action="{{ url_for('extract') }}">
                            <input type="hidden" name="airbnb_url" value="{{ url }}">
                            <input type="hidden" name="analysis_mode" value="thorough">
                            <button type="submit" class="btn btn-outline-info w-100">
                                <i class="fas fa-microscope me-2"></i>
                                Run Thorough Analysis Now
                            </button>
                        </form>
                    </div>
                    
                    <hr>
                    
                    <!-- Option 3: Go Back -->
                    <div class="text-center">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to Home
                        </a>
                    </div>
                    
                </div>
            </div>
            
            <!-- Queue Statistics -->
            <div class="card location-card mt-4">
                <div class="card-header">
                    <h3 class="h6 mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Current Queue Status
                    </h3>
                </div>
                <div class="card-body">
                    <div id="queue-stats" class="row text-center">
                        <div class="col">
                            <div class="text-muted small">Pending</div>
                            <div class="h5" id="pending-count">
                                <span class="spinner-border spinner-border-sm"></span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-muted small">Processing</div>
                            <div class="h5" id="processing-count">
                                <span class="spinner-border spinner-border-sm"></span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-muted small">Completed Today</div>
                            <div class="h5" id="completed-count">
                                <span class="spinner-border spinner-border-sm"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const queueBtn = document.getElementById('queue-btn');
    const queueStatus = document.getElementById('queue-status');
    
    if (queueBtn) {
        queueBtn.addEventListener('click', function() {
            const notes = document.getElementById('notes').value;
            const url = "{{ url }}";
            
            // Disable button and show loading
            queueBtn.disabled = true;
            queueBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Queuing...';
            
            // Send queue request
            fetch('/queue_job', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'airbnb_url': url,
                    'notes': notes,
                    'session_id': 'queue_offer'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    document.getElementById('queue-position').textContent = data.position || 'N/A';
                    document.getElementById('job-id').textContent = data.job_id || 'N/A';
                    queueStatus.style.display = 'block';
                    
                    // Hide the form
                    document.getElementById('queue-form').style.display = 'none';
                    
                    // Update queue stats
                    loadQueueStats();
                } else {
                    alert('Error: ' + (data.message || 'Failed to queue job'));
                    // Re-enable button
                    queueBtn.disabled = false;
                    queueBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Queue for Deep Analysis';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to queue job. Please try again.');
                // Re-enable button
                queueBtn.disabled = false;
                queueBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Queue for Deep Analysis';
            });
        });
    }
    
    // Load queue statistics
    function loadQueueStats() {
        fetch('/queue_status')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.stats) {
                    document.getElementById('pending-count').textContent = data.stats.pending || 0;
                    document.getElementById('processing-count').textContent = data.stats.processing || 0;
                    document.getElementById('completed-count').textContent = data.stats.completed_today || 0;
                }
            })
            .catch(error => {
                console.error('Error loading queue stats:', error);
                // Show error state
                document.getElementById('pending-count').textContent = '?';
                document.getElementById('processing-count').textContent = '?';
                document.getElementById('completed-count').textContent = '?';
            });
    }
    
    // Load stats on page load
    loadQueueStats();
});
</script>
{% endblock %}