{% extends 'layout.html' %}

{% block title %}Processing Jobs{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card location-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0">Large Batch Processing Jobs</h2>
                    <a href="{{ url_for('bulk_upload_page') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus me-1"></i> New Batch Job
                    </a>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i> This page displays your large batch processing jobs and their status. Jobs will continue processing in the background even if you leave this page.
                    </div>
                    
                    <div class="alert alert-warning mb-4">
                        <div class="d-flex">
                            <div>
                                <i class="fas fa-exclamation-triangle me-2"></i>
                            </div>
                            <div>
                                <strong>Experiencing timeouts or server errors?</strong>
                                <p class="mb-0">Enable "Safe Mode" on the bulk upload page to process requests without connecting to Airbnb servers. Safe Mode uses approximate geocoded addresses that won't be exact but will ensure job completion with no errors.</p>
                            </div>
                        </div>
                    </div>
                    
                    {% if jobs %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Filename</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Success/Total</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in jobs %}
                                    <tr class="job-row" data-job-id="{{ job.id }}">
                                        <td class="text-muted small">{{ job.id }}</td>
                                        <td>{{ job.original_filename }}</td>
                                        <td>
                                            {% if job.status == 'pending' %}
                                            <span class="badge bg-secondary">Pending</span>
                                            {% elif job.status == 'processing' %}
                                            <span class="badge bg-primary">Processing</span>
                                            {% elif job.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                            {% elif job.status == 'partially_completed' %}
                                            <span class="badge bg-info">Partial ({{ job.processed_urls }} URLs)</span>
                                            {% else %}
                                            <span class="badge bg-danger">Failed</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 15px;">
                                                <div class="progress-bar progress-bar-striped {% if job.status == 'processing' %}progress-bar-animated{% endif %}"
                                                     role="progressbar"
                                                     style="width: {{ (job.processed_urls / job.total_urls * 100) if job.total_urls > 0 else 0 }}%"
                                                     aria-valuenow="{{ (job.processed_urls / job.total_urls * 100) if job.total_urls > 0 else 0 }}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                    {{ (job.processed_urls / job.total_urls * 100) if job.total_urls > 0 else 0 }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ job.successful_urls }} / {{ job.total_urls }}</td>
                                        <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if (job.status == 'completed' or job.status == 'partially_completed') and job.result_file %}
                                            <a href="{{ url_for('download_job_results', job_id=job.id) }}" class="btn btn-sm btn-success">
                                                <i class="fas fa-download me-1"></i> Download
                                                {% if job.status == 'partially_completed' %}
                                                <span class="badge bg-warning text-dark">Partial</span>
                                                {% endif %}
                                            </a>
                                            {% else %}
                                            <button class="btn btn-sm btn-secondary" disabled>
                                                <i class="fas fa-hourglass me-1"></i> Waiting
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <p class="text-muted">No processing jobs found.</p>
                            <a href="{{ url_for('bulk_upload_page') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i> Create Your First Batch Job
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card location-card">
                <div class="card-header">
                    <h3 class="h5 mb-0">About Large Batch Processing</h3>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li class="mb-2">
                            <strong>Scalable Processing:</strong> Our system can handle up to 5,000 URLs in a single batch.
                        </li>
                        <li class="mb-2">
                            <strong>Background Processing:</strong> Large batches run in the background and you can check progress anytime.
                        </li>
                        <li class="mb-2">
                            <strong>Parallel Processing:</strong> We process multiple URLs simultaneously for high performance.
                        </li>
                        <li class="mb-2">
                            <strong>Result Download:</strong> When processing is complete, you can download the results as an Excel file.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug logger
    function logDebug(message, data) {
        console.log(`[JobMonitor] ${message}`, data || '');
    }

    // Function to update job status with improved handling
    function updateJobStatus() {
        const jobRows = document.querySelectorAll('.job-row');
        logDebug(`Checking ${jobRows.length} jobs for updates`);
        
        let hasActiveJobs = false;
        
        jobRows.forEach(row => {
            const jobId = row.getAttribute('data-job-id');
            
            // Check status for all jobs that aren't completed or failed
            const statusElement = row.querySelector('.badge');
            if (statusElement && (
                statusElement.textContent === 'Pending' || 
                statusElement.textContent === 'Processing'
            )) {
                hasActiveJobs = true;
                
                logDebug(`Fetching status for job: ${jobId}`);
                
                // Add a timestamp parameter to avoid caching
                fetch(`/api/jobs/${jobId}?_t=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        logDebug(`Received data for job ${jobId}:`, data);
                        
                        // Update status badge
                        if (data.status === 'pending') {
                            statusElement.className = 'badge bg-secondary';
                            statusElement.textContent = 'Pending';
                        } else if (data.status === 'processing') {
                            statusElement.className = 'badge bg-primary';
                            statusElement.textContent = 'Processing';
                        } else if (data.status === 'completed') {
                            statusElement.className = 'badge bg-success';
                            statusElement.textContent = 'Completed';
                            
                            // Enable download button
                            const actionCell = row.querySelector('td:last-child');
                            if (data.result_file) {
                                actionCell.innerHTML = `
                                    <a href="/api/jobs/${jobId}/download" class="btn btn-sm btn-success">
                                        <i class="fas fa-download me-1"></i> Download
                                    </a>
                                `;
                            }
                        } else if (data.status === 'partially_completed') {
                            statusElement.className = 'badge bg-info';
                            statusElement.textContent = `Partial (${data.processed_urls} URLs)`;
                            
                            // Enable download button with partial indicator
                            const actionCell = row.querySelector('td:last-child');
                            if (data.result_file) {
                                actionCell.innerHTML = `
                                    <a href="/api/jobs/${jobId}/download" class="btn btn-sm btn-success">
                                        <i class="fas fa-download me-1"></i> Download
                                        <span class="badge bg-warning text-dark">Partial</span>
                                    </a>
                                `;
                            }
                        } else {
                            statusElement.className = 'badge bg-danger';
                            statusElement.textContent = 'Failed';
                        }
                        
                        // Update progress bar
                        const progressBar = row.querySelector('.progress-bar');
                        const progressPercentage = Math.round(data.progress_percentage);
                        progressBar.style.width = `${progressPercentage}%`;
                        progressBar.setAttribute('aria-valuenow', progressPercentage);
                        progressBar.textContent = `${progressPercentage}%`;
                        
                        if (data.status !== 'processing') {
                            progressBar.classList.remove('progress-bar-animated');
                        }
                        
                        // Update processed/total count
                        const countCell = row.querySelector('td:nth-child(5)');
                        countCell.textContent = `${data.successful_urls} / ${data.total_urls}`;
                        
                        // If job status changed to completed/failed, refresh the page after a delay
                        if ((data.status === 'completed' || data.status === 'failed') && 
                            (statusElement.textContent === 'Pending' || statusElement.textContent === 'Processing')) {
                            logDebug(`Job ${jobId} is now ${data.status}, will refresh soon`);
                            setTimeout(() => {
                                window.location.reload();
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        console.error(`Error updating job ${jobId}:`, error);
                        // Retry after a short delay for transient errors
                        setTimeout(() => {
                            updateSingleJob(jobId, row);
                        }, 2000);
                    });
            }
        });
        
        // Log if no active jobs
        if (!hasActiveJobs) {
            logDebug('No active jobs to monitor');
        }
    }
    
    // Function to update a single job (for retries)
    function updateSingleJob(jobId, row) {
        logDebug(`Retrying update for job: ${jobId}`);
        fetch(`/api/jobs/${jobId}?_retry=1&_t=${Date.now()}`)
            .then(response => response.json())
            .then(data => {
                logDebug(`Retry successful for job ${jobId}`, data);
                // Update status (simplified)
                const statusElement = row.querySelector('.badge');
                if (statusElement) {
                    statusElement.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                }
            })
            .catch(error => console.error(`Retry failed for job ${jobId}:`, error));
    }
    
    // Update job status immediately
    updateJobStatus();
    
    // Then update every 3 seconds for more responsive updates
    const statusInterval = setInterval(updateJobStatus, 3000);
    
    // Stop polling after 30 minutes to prevent resource waste if page left open
    setTimeout(() => {
        clearInterval(statusInterval);
        logDebug('Stopped automatic job status polling after timeout');
    }, 30 * 60 * 1000);
});
</script>
{% endblock %}